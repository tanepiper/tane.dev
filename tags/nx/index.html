<!doctype html><html lang=en-gb prefix="og: https://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.145.0"><title>NX - Development tutorials for modern web development</title>
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,800" rel=stylesheet><link rel=stylesheet href=https://pro.fontawesome.com/releases/v5.7.2/css/all.css integrity=sha384-6jHF7Z3XI3fF4XZixAuSu0gGKrXwoX/w3uFPxC56OtjChio7wtTGJWRW53Nhx6Ev crossorigin=anonymous><link rel=stylesheet href=https://tane.dev/css/bundle.min.c2e4851d86d378b94d217eb138010f3338a9a41dbe246b7dc2c3fb5364d00a978fd2595df8bb2d30354eae35fd3895f5c7724e01082268c043ba77f50a56e091.css integrity="sha512-wuSFHYbTeLlNIX6xOAEPMzippB2+JGt9wsP7U2TQCpeP0lld+LstMDVOrjX9OJX1x3JOAQgiaMBDunf1ClbgkQ=="><link rel=alternate type=application/rss+xml href=https://tane.dev/tags/nx/index.xml title=tane.dev><meta property="og:image" content="https://www.mugshotbot.com/m?mode=light&theme=two_up&pattern=lines_in_motion&image=d3d350d5&hide_watermark=true&url=https://tane.dev/tags/nx/"><meta name=twitter:image content="https://www.mugshotbot.com/m?mode=light&theme=two_up&pattern=lines_in_motion&image=d3d350d5&hide_watermark=true&url=https://tane.dev/tags/nx/"><meta property="og:title" content="NX"><meta name=twitter:title content="NX"><meta name=twitter:card content="summary_large_image"><meta property="og:description" content="Development tutorials for modern web development"><meta name=twitter:description content="Development tutorials for modern web development"><meta property="og:url" content="https://tane.dev/tags/nx/"><meta property="og:site_name" content="tane.dev"><meta property="og:type" content="website"><script src=https://cdn.usefathom.com/script.js data-site=HNGWYVWJ defer></script><link rel=webmention href=https://webmention.io/tane.dev/webmention><link rel=pingback href=https://webmention.io/tane.dev/xmlrpc><meta name=msvalidate.01 content="33A8CFE8ACA5056A4E6D626DE029C0FE"></head><body class=light><div class=container-left><div class=row><div class="column sidebar"><div class=sidebar-content><h1 class="site-title flex-item flex-start" title="The title of the site tane.dev - click it to go back to the homepage" aria-label="The title of the site tane.dev - click it to go back to the homepage"><a href=https://tane.dev/ title="Click here to go back to the home page">tane.dev</a></h1><h2 class="flex-item subtitle" title="The subtitle of the site, is has a brain in it which makes the assumption the author has one" aria-label="The subtitle of the site, is has a brain in it which makes the assumption the author has one">[ <i class="far fa-head-side-brain"></i> ideas <sup>& stuff</sup> ]</h2><aside class=menu><ul class="sidebar-menus menu-list"><li>&#187; <a href=https://tane.dev/about>About</a></li><li>&#187; <a href=https://tane.dev/projects>Projects</a></li></ul><h3 class=menu-label title="A recent list of posts I've somehow managed to write down"><i class="far fa-keyboard"></i> Recent Posts:</h3><ul class=previous-posts><li><a href=https://tane.dev/2023/09/slack-wants-you-you-know-this-privacy-exploit-is-fine/>Slack wants you you know this privacy exploit is fine</a>
<span>Published: Sep 25, 2023</span></li><li><a href=https://tane.dev/2023/04/i-think-i-found-a-privacy-exploit-in-chatgpt/>I Think I Found a Privacy Exploit in ChatGPT</a>
<span>Published: Apr 14, 2023</span></li><li><a href=https://tane.dev/2021/02/announcing-formula-a-zero-config-reactive-forms-library-for-svelte/>Announcing Formula - A Zero-Config Reactive Forms Library for Svelte</a>
<span>Published: Feb 13, 2021</span></li><li><a href=https://tane.dev/2021/02/revisiting-dark-patterns-with-the-html-dialog-tag/>Revisiting Dark patterns with the HTML &lt;dialog> tag</a>
<span>Published: Feb 8, 2021</span></li><li><a href=https://tane.dev/2021/02/webserial.app-browser-to-usb-serial-communication-with-svelte/>WebSerial.app - Browser to USB Serial Communication With Svelte</a>
<span>Published: Feb 5, 2021</span></li></ul><a href=https://tane.dev/archive>All Previous Posts &rang;</a><div class=feed><a href=https://tane.dev//index.xml><i class="far fa-rss-square"></i>&nbsp;RSS Feed</a></div></aside><div class=service-buttons><a class=flex-item href=https://github.com/tanepiper title="Link to my Github" target=_new rel=me><i class='fab fa-github-alt'></i></a>
<a class=flex-item href=https://linkedin.com/in/tanepiper title="Link to my LinkedIn" target=_new rel=me><i class='fab fa-linkedin'></i></a>
<a class=flex-item href=https://tane.codes/@tanepiper title="Link to my Mastodon" target=_new rel=me><i class='fab fa-mastodon'></i></a></div><footer class=footer><div class="flex-item contact"><i class="far fa-copyright"></i>&nbsp;2025 Tane Piper
<a href=mailto: title="I promise I check this from time to time" aria-label="I promise I check this from time to time"><i class="far fa-mailbox"></i>&nbsp;Email into the void</a></div><div class="flex-item meta"><div><i class="fas fa-hammer"></i>&nbsp;Site built with <a href=http://gohugo.io>Hugo</a> 0.145.0 <a href=https://tane.dev//about title="Click on this link to go to the about page"><sup>[about]</sup></a></div><div><i class="far fa-business-time"></i> Last modified 2025-09-09 12:31</div></div></footer><div class=theme-buttons><div class="flex-item button-group-label">Theme:</div><button class="flex-item btn btn-circle btn-theme btn-light" data-theme=light title="Click this button for the light theme" aria-label="Click this button for the light theme">
<button class="flex-item btn btn-circle btn-theme btn-dark" data-theme=dark title="Click this button for the dark theme" aria-label="Click this button for the dark theme">
<button class="flex-item btn btn-circle btn-theme btn-darkgreen" data-theme=darkgreen title="Click this button for the darkgreen theme" aria-label="Click this button for the darkgreen theme"></div></div><style type=text/css>.previous-posts li{flex-direction:column}.previous-posts li span{margin-left:.5rem;border-left:1px solid #d3d3d3;justify-content:right}</style></div><main class="column main"><h2 class=taxonomy-title title="The taxonomy of this page is NX" aria-label="The taxonomy of this page is NX">NX</h2><div class=post><div class=post-heading><h1><a href=https://tane.dev/2020/05/publishing-npm-libraries-using-nx-and-github-actions/>Publishing NPM Libraries using NX and Github Actions</a></h1><div class=meta><i class="far fa-calendar-edit" title="The date when this post was originally published" aria-label="The date when this post was originally published"></i><span>&nbsp;Published: May 7, 2020</span>
|&nbsp;<i class="far fa-pencil" title="The number of semi-coherent words I managed to produce" aria-label="The number of semi-coherent words I managed to produce"></i><span>~ 2200 words</span>
|&nbsp;<i class="far fa-clock" title="Time is an illusion. Lunchtime doubly so" aria-label="Time is an illusion. Lunchtime doubly so"></i><span>~ 10 minutes reading time</span></div><div class=tags title="Click the links in this to go to a page based on a tag value" aria-label="Click the links in this to go to a page based on a tag value"><a class=flex-item href=https://tane.dev/tags/nx>NX</a>
<a class=flex-item href=https://tane.dev/tags/github>Github</a>
<a class=flex-item href=https://tane.dev/tags/npm>NPM</a>
<a class=flex-item href=https://tane.dev/tags/library>Library</a>
<a class=flex-item href=https://tane.dev/tags/monorepo>Monorepo</a></div></div><div class=post-content><p>This week I released version 1.0 of <a href=https://tanepiper.github.io/rxjs-primitives/ target=_blank>RxJS Primitives</a>
to NPM - but the
journey to get there was not as easy as I hoped.</p><p>In the past I&rsquo;ve used <a href=https://circleci.com/ target=_blank>CircleCI</a>
and at work I use <a href=https://www.jenkins.io/ target=_blank>Jenkins</a>
but with this project I wanted to try out <a href=https://github.com/features/actions target=_blank>Github Actions</a>
.</p><p>After some trial an error (and many failed builds) I managed to get the workflow working, I&rsquo;ve decided to share here the
steps taken to hopefully save you from the same pain.</p><h2 id=setting-up-your-monorepo>Setting up your monorepo</h2><p>The <a href=https://nx.dev/ target=_blank>NX</a>
CLI is a set of tools that make managing your repository of JavaScript and TypeScript code
easy. Originally built on top of the <a href=https://cli.angular.io/ target=_blank>Angular CLI</a>
the tooling now supports more project types
including Node, React and Web Components.</p><p>In my day-job most of my work is building Angular Enterprise applications, but I also work on my own open source
software and in both cases I use NX, including using it to publish Angular and TypeScript libraries to NPM.</p><p>Each way of setting this up is subtly different. In this example I&rsquo;ll show the steps of how I built a pipeline for
releasing my TypeScript RxJS library.</p><p>The easiest way to start is to create your repo
using <a href=https://www.npmjs.com/package/create-nx-workspace target=_blank><code>create-nx-workspace</code></a></p><blockquote><p><code>npx create-nx-workspace &lt;project-name></code></p></blockquote><p>When running this, you will be asked a few questions depending on your setup. For <code>RxJS Primitives</code> I used a plain
workspace, and then once created I added <a href=https://www.npmjs.com/package/@nrwl/node target=_blank><code>@nrwl/node</code></a>
to the project. The
default <code>@nrwl/workspace</code>
plugin allows the creation of libraries, but does not provide a publishable output (adding <code>package.json</code>) as an option.</p><p>Once set up you can now create libraries that can be built and published as NPM modules, using the <code>@nrwl/node</code> plugin
type to create them. For <code>rxjs-string</code> I used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; nx g @nrwl/node:library --name<span style=color:#f92672>=</span>string --directory<span style=color:#f92672>=</span>rxjs --publishable
</span></span></code></pre></div><p>If it&rsquo;s an Angular library use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; nx g @nrwl/angular:library --name<span style=color:#f92672>=</span>my-component --directory<span style=color:#f92672>=</span>ngx --publishable
</span></span></code></pre></div><p>After a few seconds, inside the <code>libs</code> folder will be a default output of a TypeScript library, with
various <code>tsconfig.json</code> files for testing and building, a <a href=https://jestjs.io/ target=_blank>Jest</a>
config for unit testing,
a <code>index.ts</code> file as the entry point and <code>package.json</code> for publishing.</p><blockquote><p>One issue with <code>nx</code> is that with this configuration in the <code>package.json</code> you&rsquo;ll find a 2-level
name for your library (e.g. <code>@tinynodes/rxjs-string</code>) however in the root <code>tsconfig.json</code> file you&rsquo;ll see the following
in the <code>paths</code> property</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;paths&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;@tinynodes/rxjs/string&#34;</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;libs/rxjs/string/src/index.ts&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you are only using this library internally it&rsquo;s not really an issue, but when you intend to publish the library I
recommend changing the path to <code>@tinynodes/rxjs-string</code> to match the NPM import path.</p><h2 id=preparing-for-publishing>Preparing for publishing</h2><p>Once you have developed your library, it&rsquo;s time to publish to NPM! First of all, make sure your public API
(Functions, Classes, and Types) are exported in the library <code>index.ts</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// index.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> { <span style=color:#a6e22e>myFactoryFunction</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./libs/factory&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> { <span style=color:#a6e22e>MyThing</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./classes/my-thing&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> { <span style=color:#a6e22e>MyInterface</span>, <span style=color:#a6e22e>SOME_CONSTANT</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./types/thing-types&#39;</span> 
</span></span></code></pre></div><p>To see the output of this library you can run <code>nx build library-name</code>, this will output a NPM module to the <code>dist</code>
folder.</p><h2 id=setting-up-github-actions-for-pull-requests>Setting up Github Actions for Pull Requests</h2><p>For an open-source library on GitHub, it&rsquo;s good practice for you to get pull requests from other developers, and to have
confidence in those PRs having a pull request checker is ideal.</p><p>First create a folder <code>.github</code> at the root of your workspace, and inside the <code>workflows</code> folder. This is the folder
that GitHub checks to see if there are any YAML files containing action flows.</p><p>Create a file <code>pr_on_master.yml</code> and inside this file set up the following steps:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># File for Pull Request on master branch</span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>PR on master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># When a PR is opened to master</span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pull_request</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>types</span>: [ <span style=color:#ae81ff>opened, reopened, synchronize ]</span>
</span></span></code></pre></div><p>This first section provides the name and triggers for when the action runs: when a pull request opened or re-opened
against <code>master</code>.</p><p>Next the steps need set up:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Setup OS and Node Version</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>matrix</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Latest nodes only</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>node-version</span>: [ <span style=color:#ae81ff>13.</span><span style=color:#ae81ff>x ]</span>
</span></span></code></pre></div><p>This sets up a Github Action runner and makes sure NodeJS 13 is installed. Here you can add more versions and run
parallel tests against different versions if you plan to support more than one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Define Steps</span>
</span></span><span style=display:flex><span><span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Checkout code</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ref</span>: <span style=color:#ae81ff>${{ github.event.pull_request.head.ref }}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>fetch-depth</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Use Node.js ${{ matrix.node-version }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/setup-node@v1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>node-version</span>: <span style=color:#ae81ff>${{ matrix.node-version }}</span>
</span></span></code></pre></div><p>The first two steps first check out the code from the pull request branch, and then sets up NodeJS to run.</p><p>The next piece of step was the part of setting up the pipeline that took the longest to fix.</p><p>To use the <code>nx affected</code> commands it needs a base branch to compare changes against - by default Github checkout does
not pull all the branches, only the current one - and this includes the master branch. This command tells git to pull
the master branch from the origin:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#75715e># Make sure we have all branches</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Fetch other branches</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: <span style=color:#ae81ff>git fetch --no-tags --prune --depth=5 origin master</span>
</span></span></code></pre></div><p>Finally, we run some NPM command for installing the dependencies, running linting and test coverage.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install environment</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm ci</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run lint</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm run affected:lint -- --base=&#34;origin/master&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Tests coverage</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm run affected:test -- --base=&#34;origin/master&#34; --codeCoverage</span>
</span></span></code></pre></div><p>Using the affected commands, the pipeline will only run linting and testing against libraries that have changed against
the master branch. More steps such as <a href=https://sonarqube.org target=_blank>SonarQube</a>
or other webhooks can be performed here.</p><h3 id=publishing-to-npm>Publishing to NPM</h3><p>When publishing libraries, there&rsquo;s a few additional steps needed before we write the pipeline. First of all we need two
access tokens, one for NPM and one for GitHub.</p><h4 id=npm-token>NPM Token</h4><p>The NPM token will be used to publish the library to the public NPM registry. Log into NPM and under your profile go to
the &ldquo;Auth Tokens&rdquo;
section and create a new token with &ldquo;Publish&rdquo; access. Next go to your Github repository and under &ldquo;Settings -> Secrets&rdquo;
add a new token called <code>NPM_AUTH_TOKEN</code> and paste in the value.</p><blockquote><p>If publishing to a private registry follow it&rsquo;s instructions on generating an API token.</p></blockquote><h4 id=github-token>Github Token</h4><p>To publish changes back to GitHub from the pipeline you also need a personal access token - this can be created under
your account settings in &ldquo;Developer Settings -> Personal Access Token&rdquo;. The only permissions you need to give this token
are the <code>repo</code> permissions.</p><p>Add this under &ldquo;Settings -> Secrets&rdquo; as <code>ACTION_AUTH_TOKEN</code> (it seems you cannot name them with <code>GITHUB_</code> in the name at
all) ü§∑‚Äç‚ôÇÔ∏è</p><h4 id=setting-up-the-action>Setting up the action</h4><p>Like before we are going to add a YAML file to the <code>.github/workflows</code> folder - this time called <code>publish.yml</code></p><p>First set the action up to trigger only when a PR is closed on <code>master</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Merge on master</span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pull_request</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>types</span>: [ <span style=color:#ae81ff>closed ]</span>
</span></span></code></pre></div><p>The <code>job</code> section is the same as above, but for the steps there is a slight change - to allow merges to master that *
don&rsquo;t* trigger a release, each command will be wrapped in a <code>if</code> block this block checks the commit message for the
string <code>[skip-ci]</code> to avoid running these tasks (unfortunatly it seems you can&rsquo;t just put a block around the entire set
of steps so has to be added to all of them)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Checkout code</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Checkout Code</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.event.pull_request.merged == true &amp;&amp; contains(github.event.commits[0].message, &#39;[skip-ci]&#39;) == false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span></code></pre></div><p>Instead of running lint and test, we&rsquo;ll now run a set of different tasks - hold on tight because we&rsquo;re about to dive
into some <code>bash</code> code!</p><h4 id=deployment-step>Deployment Step</h4><p>In our <code>publish.yaml</code> add the following step which first exports our registry publishing setting with the auth token we
set up earlier, then we call our publish bash script</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Deploy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.event.pull_request.merged == true &amp;&amp; contains(github.event.commits[0].message, &#39;[skip-ci]&#39;) == false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>NPM_AUTH_TOKEN</span>: <span style=color:#ae81ff>${{ secrets.NPM_AUTH_TOKEN }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      npm config set //registry.npmjs.org/:_authToken=$NPM_AUTH_TOKEN
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ./.github/scripts/publish-libraries.sh</span>
</span></span></code></pre></div><p>Create the <code>.github/scripts/publish-libraries.sh</code> file and make sure it&rsquo;s set to executable by
typing <code>chmod +x .github/scripts/publish-libraries.sh</code> before committing the script.</p><p>The first part of the script is setting up our variables and <code>getBuildType</code> function to check what type of release we
are doing. It&rsquo;s good to use <a href=https://semver.org/ target=_blank>SemVer</a>
to publish based on changes that happen in the library and
with this function using the following words in the <strong>MERGE COMMIT</strong> message will determine the release type.</p><p>For example: <code>(fix): Fixed that annoying bug in issue #123</code> will set the release type to <code>patch</code>. The default is <code>minor</code>
. Using <code>(feat)</code> will make a major change.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -o errexit -o noclobber -o nounset -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This script uses the parent version as the version to publish a library with</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>getBuildType<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  local release_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;minor&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;feat&#34;</span>* <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    release_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;major&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>elif</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;fix&#34;</span>* <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;docs&#34;</span>* <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;chore&#34;</span>* <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    release_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;patch&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;</span>$release_type<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PARENT_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>ROOT_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.&#34;</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Removing Dist&#34;</span>
</span></span><span style=display:flex><span>rm -rf <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>ROOT_DIR:?<span style=color:#e6db74>}</span><span style=color:#e6db74>/dist&#34;</span>
</span></span><span style=display:flex><span>COMMIT_MESSAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>git log -1 --pretty<span style=color:#f92672>=</span>format:<span style=color:#e6db74>&#34;%s&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>RELEASE_TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>1<span style=color:#66d9ef>:-$(</span>getBuildType <span style=color:#e6db74>&#34;</span>$COMMIT_MESSAGE<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>DRY_RUN<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>DRY_RUN<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;False&#34;</span><span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>The script also cleans up the dist folder, and has an optional <code>DRY_RUN</code> to set if you want to test the pipeline before
release.</p><p>After this add the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AFFECTED<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>node node_modules/.bin/nx affected:libs --plain --base<span style=color:#f92672>=</span>origin/master~1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$AFFECTED<span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  cd <span style=color:#e6db74>&#34;</span>$PARENT_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;Copy Environment Files&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> IFS<span style=color:#f92672>=</span> read -r -d <span style=color:#e6db74>$&#39; &#39;</span> lib; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Setting version for </span>$lib<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    cd <span style=color:#e6db74>&#34;</span>$PARENT_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    cd <span style=color:#e6db74>&#34;</span>$ROOT_DIR<span style=color:#e6db74>/libs/</span><span style=color:#e6db74>${</span>lib/-//<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    npm version <span style=color:#e6db74>&#34;</span>$RELEASE_TYPE<span style=color:#e6db74>&#34;</span> -f -m <span style=color:#e6db74>&#34;RxJS Primitives </span>$RELEASE_TYPE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Building </span>$lib<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    cd <span style=color:#e6db74>&#34;</span>$PARENT_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    npm run build <span style=color:#e6db74>&#34;</span>$lib<span style=color:#e6db74>&#34;</span> -- --prod --with-deps
</span></span><span style=display:flex><span>    wait
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span> <span style=color:#f92672>&lt;&lt;&lt;</span><span style=color:#e6db74>&#34;</span>$AFFECTED<span style=color:#e6db74> &#34;</span> <span style=color:#75715e># leave space on end to generate correct output</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cd <span style=color:#e6db74>&#34;</span>$PARENT_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> IFS<span style=color:#f92672>=</span> read -r -d <span style=color:#e6db74>$&#39; &#39;</span> lib; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$DRY_RUN<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;False&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      echo <span style=color:#e6db74>&#34;Publishing </span>$lib<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>      npm publish <span style=color:#e6db74>&#34;</span>$ROOT_DIR<span style=color:#e6db74>/dist/libs/</span><span style=color:#e6db74>${</span>lib/-//<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> --access<span style=color:#f92672>=</span>public
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      echo <span style=color:#e6db74>&#34;Dry Run, not publishing </span>$lib<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    wait
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span> <span style=color:#f92672>&lt;&lt;&lt;</span><span style=color:#e6db74>&#34;</span>$AFFECTED<span style=color:#e6db74> &#34;</span> <span style=color:#75715e># leave space on end to generate correct output</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;No Libraries to publish&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>This part of the script allows us to control the build and release - the first line gets a single line list of affected
libraries from the current <code>master</code> to the last <code>HEAD</code> in <code>master</code> - if you use only PRs to make changes into <code>master</code>
this is very effective - but can break if you make changes directly to <code>master</code>.</p><p>This is done instead of using <code>nx affected</code> as there is currently no task for publishing, so this gives a way to provide
a loop for both building and publishing.</p><p>Both <code>while</code> loops parses this string and splits on the space to allow a loop to be run.</p><blockquote><p>In each loop there is a string replacement <code>${lib/-//}</code> - this changes the library name (e.g. <code>rxjs-string</code>) into a path (<code>rxjs/string</code>)</p></blockquote><p>The first <code>while</code> loop ensures we are in the correct directory and does <code>npm version</code> - bumping the <code>package.json</code> for
release - it then runs the build task for production, and ensures any dependencies are also build.</p><p>The second <code>while</code> loop iterates over the same list but runs the <code>npm publish</code> command in each directory, setting the
access to public.</p><h4 id=congratulations>Congratulations</h4><p>If you&rsquo;ve made it this far, well done - this is quite a long post! At this point your pipeline should have successfully
published your NPM module for other developers to use! We&rsquo;re not done yet though!</p><p>Before running this we are going to add some additional steps so that we can publish documentation and changes back to
Github:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build Docs</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.event.pull_request.merged == true &amp;&amp; contains(github.event.commits[0].message, &#39;[skip-ci]&#39;) == false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm run docs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Commit files</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.event.pull_request.merged == true &amp;&amp; contains(github.event.commits[0].message, &#39;[skip-ci]&#39;) == false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      git config --local user.email &#34;action@github.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      git config --local user.name &#34;GitHub Action&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      git add .
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      git commit -m &#34;Release [skip-ci]&#34; -a || true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Push changes</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.event.pull_request.merged == true &amp;&amp; contains(github.event.commits[0].message, &#39;[skip-ci]&#39;) == false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>ad-m/github-push-action@master</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>github_token</span>: <span style=color:#ae81ff>${{ secrets.ACTION_AUTH_TOKEN }}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>tags</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>force</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>For RxJS Primitives I used <a href=https://typedoc.org/ target=_blank>TypeDoc</a>
to generate static content to the <code>docs</code> folder, which is
then used by GitHub Pages, but here you can set up whatever documentation system you prefer.</p><p>Once the docs have been generated we then commit all changes including the <code>package.json</code> version bumps back to git and
then finally push it back to <code>master</code> using the GitHub token generated earlier.</p><p>Within a few seconds your GitHub Page should update with the latest content, the master branch reflect all changes made.</p><p>That&rsquo;s a wrap! You&rsquo;ve now successfully published your TypeScript library for other developers to use, along with
documentation.</p><p>If you&rsquo;ve found this article useful, let me know - and if you find any issues or improvements please get in touch!</p></div></div><div class=text-center></div></main></div><style>.taxonomy-title{padding-left:1rem}.taxonomy-title:before{font-family:'font awesome 5 pro';content:'\f02c';display:inline-block;padding-right:.5rem;vertical-align:middle;font-weight:900}</style></div><footer></footer><script src=https://tane.dev/vendor/rxjs.umd.min.cfc67dfcb1df9b0e06f96ac2e2bf29507e56ff70c80563ef778250b702add65b76253e3a28b4528f9baadca92b9b2d35f64884365ff4ae673dfeb3d0c3b61a91.js integrity="sha512-z8Z9/LHfmw4G+WrC4r8pUH5W/3DIBWPvd4JQtwKt1lt2JT46KLRSj5uq3Kkrmy019kiENl/0rmc9/rPQw7YakQ=="></script><script src=https://tane.dev/js/bundle.min.c218495446b0af055063d5a2d131d9bdbf1346a6d558d6843997c8c69e4e1f41106b5a32b053482d4fc6c6dd7c3ac1d18e0039a33506d68f311d5b6e37429eb4.js integrity="sha512-whhJVEawrwVQY9Wi0THZvb8TRqbVWNaEOZfIxp5OH0EQa1oysFNILU/Gxt18OsHRjgA5ozUG1o8xHVtuN0KetA==" defer></script><script async data-id=101405924 src=//static.getclicky.com/js></script></body></html>